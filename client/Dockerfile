# 游댳 Etapa 1: Build de la app con Vite
FROM node:22-alpine as build

WORKDIR /app

# Copiamos solo lo necesario primero para aprovechar la cache de Docker
COPY package*.json ./

RUN npm install

# Ahora s칤 copiamos todo lo dem치s
COPY . .

# Ejecutamos el build (esto generar치 /dist)
RUN npm run build

# 游댳 Etapa 2: Imagen liviana para producci칩n
FROM node:22-alpine

# Instalar PM2 de forma global
RUN npm install -g pm2

WORKDIR /app

# Copiar el build
COPY --from=build /app/dist ./dist

# Copiar solo los archivos necesarios para ejecutar el servidor
COPY package*.json ./
COPY server.js .
COPY ecosystem.config.js .

# Instalamos solo dependencias de producci칩n
RUN npm install --omit=dev

EXPOSE 3000

# Arrancamos el servidor con PM2
CMD ["pm2-runtime", "server.js", "--name", "client"]
